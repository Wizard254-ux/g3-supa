######################################################################
# FreeRADIUS Custom SQL Queries for Dynamic Session-Timeout
#
# Deploy this to: /etc/freeradius/3.0/mods-config/sql/main/mysql/queries.conf
#
# This makes FreeRADIUS calculate remaining time on EVERY Access-Request
# based on the expires_at timestamp stored in radcheck table.
######################################################################

# Authorization Check Query
# Returns user credentials if:
# - User exists
# - Status is 'active'
# - Package has NOT expired (expires_at >= NOW() or is NULL)
authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM ${authcheck_table} \
    WHERE username = '%{SQL-User-Name}' \
    AND (status = 'active' OR status IS NULL) \
    AND (expires_at IS NULL OR expires_at >= NOW()) \
    ORDER BY id"

# Authorization Reply Query
# Returns RADIUS reply attributes with DYNAMIC Session-Timeout
#
# How it works:
# - If attribute is 'Session-Timeout' AND expires_at is set:
#   Calculate: remaining_seconds = expires_at - NOW()
#   Return: MAX(60, remaining_seconds) to avoid timeouts < 1 minute
# - Otherwise return the stored value as-is
#
# Result: User gets actual remaining time, not static 24 hours
authorize_reply_query = "\
    SELECT \
        rr.id, \
        rr.username, \
        rr.attribute, \
        rr.op, \
        CASE \
            WHEN rr.attribute = 'Session-Timeout' AND rc.expires_at IS NOT NULL THEN \
                CAST(GREATEST(60, TIMESTAMPDIFF(SECOND, NOW(), rc.expires_at)) AS CHAR) \
            ELSE rr.value \
        END as value \
    FROM ${authreply_table} rr \
    LEFT JOIN ${authcheck_table} rc ON rr.username = rc.username \
    WHERE rr.username = '%{SQL-User-Name}' \
    ORDER BY rr.id"

# Group Check Query (optional - if you use groups)
authorize_group_check_query = "\
    SELECT id, groupname, attribute, value, op \
    FROM ${groupcheck_table} \
    WHERE groupname = '%{${group_attribute}}' \
    ORDER BY id"

# Group Reply Query (optional - if you use groups)
authorize_group_reply_query = "\
    SELECT id, groupname, attribute, value, op \
    FROM ${groupreply_table} \
    WHERE groupname = '%{${group_attribute}}' \
    ORDER BY id"

######################################################################
# Accounting Queries
######################################################################

# Accounting Start
accounting_start_query = "\
    INSERT INTO ${acct_table1} \
        (acctsessionid, acctuniqueid, username, realm, nasipaddress, \
         nasportid, nasporttype, acctstarttime, acctupdatetime, \
         acctstoptime, acctsessiontime, acctauthentic, connectinfo_start, \
         connectinfo_stop, acctinputoctets, acctoutputoctets, calledstationid, \
         callingstationid, acctterminatecause, servicetype, framedprotocol, \
         framedipaddress) \
    VALUES \
        ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', \
         '%{Realm}', '%{NAS-IP-Address}', '%{%{NAS-Port-ID}:-%{NAS-Port}}', \
         '%{NAS-Port-Type}', FROM_UNIXTIME(%{integer:Event-Timestamp}), \
         FROM_UNIXTIME(%{integer:Event-Timestamp}), NULL, 0, '%{Acct-Authentic}', \
         '%{Connect-Info}', '', 0, 0, '%{Called-Station-Id}', \
         '%{Calling-Station-Id}', '', '%{Service-Type}', '%{Framed-Protocol}', \
         '%{Framed-IP-Address}')"

# Accounting Update
accounting_update_query = "\
    UPDATE ${acct_table1} \
    SET \
        acctupdatetime = FROM_UNIXTIME(%{integer:Event-Timestamp}), \
        acctsessiontime = %{%{Acct-Session-Time}:-NULL}, \
        acctinputoctets = %{%{Acct-Input-Gigawords}:-0} << 32 | %{%{Acct-Input-Octets}:-0}, \
        acctoutputoctets = %{%{Acct-Output-Gigawords}:-0} << 32 | %{%{Acct-Output-Octets}:-0} \
    WHERE acctsessionid = '%{Acct-Session-Id}' \
    AND username = '%{SQL-User-Name}' \
    AND nasipaddress = '%{NAS-IP-Address}'"

# Accounting Stop
accounting_stop_query = "\
    UPDATE ${acct_table1} \
    SET \
        acctstoptime = FROM_UNIXTIME(%{integer:Event-Timestamp}), \
        acctsessiontime = %{%{Acct-Session-Time}:-NULL}, \
        acctinputoctets = %{%{Acct-Input-Gigawords}:-0} << 32 | %{%{Acct-Input-Octets}:-0}, \
        acctoutputoctets = %{%{Acct-Output-Gigawords}:-0} << 32 | %{%{Acct-Output-Octets}:-0}, \
        acctterminatecause = '%{Acct-Terminate-Cause}', \
        connectinfo_stop = '%{Connect-Info}' \
    WHERE acctsessionid = '%{Acct-Session-Id}' \
    AND username = '%{SQL-User-Name}' \
    AND nasipaddress = '%{NAS-IP-Address}'"

# Accounting On/Off
accounting_on_query = ""
accounting_off_query = ""

######################################################################
# Post-Auth Query
######################################################################

postauth_query = "\
    INSERT INTO ${postauth_table} \
        (username, pass, reply, authdate) \
    VALUES \
        ('%{SQL-User-Name}', \
         '%{%{User-Password}:-%{Chap-Password}}', \
         '%{reply:Packet-Type}', \
         NOW())"

######################################################################
# End of queries
######################################################################
