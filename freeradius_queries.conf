######################################################################
# FreeRADIUS Custom SQL Queries for Dynamic Session-Timeout
#
# Deploy this to: /etc/freeradius/3.0/mods-config/sql/main/mysql/queries.conf
#
# This makes FreeRADIUS calculate remaining time on EVERY Access-Request
# based on the expires_at timestamp stored in radcheck table.
######################################################################

# Authorization Check Query
# Returns user credentials if:
# - User exists
# - Status is 'active'
# - Package has NOT expired (expires_at >= NOW() or is NULL)
authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM ${authcheck_table} \
    WHERE username = '%{SQL-User-Name}' \
    AND (status = 'active' OR status IS NULL) \
    AND (expires_at IS NULL OR expires_at >= NOW()) \
    ORDER BY id"

# Authorization Reply Query
# Returns RADIUS reply attributes with DYNAMIC Session-Timeout
#
# How it works:
# - If attribute is 'Session-Timeout' AND expires_at is set:
#   Calculate: remaining_seconds = expires_at - NOW()
#   Return: MAX(60, remaining_seconds) to avoid timeouts < 1 minute
# - Otherwise return the stored value as-is
#
# Result: User gets actual remaining time, not static 24 hours
authorize_reply_query = "\
    SELECT \
        rr.id, \
        rr.username, \
        rr.attribute, \
        rr.op, \
        CASE \
            WHEN rr.attribute = 'Session-Timeout' AND rc.expires_at IS NOT NULL THEN \
                CAST(GREATEST(60, TIMESTAMPDIFF(SECOND, NOW(), rc.expires_at)) AS CHAR) \
            ELSE rr.value \
        END as value \
    FROM ${authreply_table} rr \
    LEFT JOIN ${authcheck_table} rc ON rr.username = rc.username \
    WHERE rr.username = '%{SQL-User-Name}' \
    ORDER BY rr.id"

# Group Check Query (keep default - not used for MAC auth)
authorize_group_check_query = ""

# Group Reply Query (keep default - not used for MAC auth)
authorize_group_reply_query = ""

######################################################################
# Accounting Queries
######################################################################

# Use default accounting queries (keep them empty to use FreeRADIUS defaults)
accounting_start_query = ""
accounting_update_query = ""
accounting_stop_query = ""
accounting_on_query = ""
accounting_off_query = ""

######################################################################
# Post-Auth Query
######################################################################

# Use default postauth query
postauth_query = ""

######################################################################
# End of queries
######################################################################
